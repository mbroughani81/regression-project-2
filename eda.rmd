```{r setup}
knitr::opts_chunk$set(cache = TRUE)
```

```{r}
load_libraries <- function() {
  library(readr)
  library(dplyr)
  library(ggplot2)
  library(jalcal)
  library(furrr)
  library(purrr)
  library(lubridate)
}
load_libraries()
```

```{r}
# products <- read_csv("data/digikala-products.csv")
# comments <- read_csv("data/digikala-comments.csv")
load("/media/mbroughani81/500A6DE90A6DCC92/uni/8/Regression/Project-2/data/products.rda")
load("/media/mbroughani81/500A6DE90A6DCC92/uni/8/Regression/Project-2/data/comments.rda")
```

#### Products - rename columns 

```{r}
# $$rename_columns <- function(df) {
#   df %>%
#     rename(
#       rate = Rate,
#       rate_cnt = Rate_cnt,
#       category_1 = Category1,
#       category_2 = Category2,
#       brand = Brand,
#       price = Price,
#       seller = Seller,
#       is_fake = Is_Fake
#     )
# }
# products <- rename_columns(products)

# convert_to_georgian <- function(comments) {
#   print("???")
#   created_at_uniq <- comments$created_at %>% unique()
#   fun <- function(x) {
#     x <- gsub("فروردین", "1", x)
#     x <- gsub("اردیبهشت", "2", x)
#     x <- gsub("خرداد", "3", x)
#     x <- gsub("تیر", "4", x)
#     x <- gsub("مرداد", "5", x)
#     x <- gsub("شهریور", "6", x)
#     x <- gsub("مهر", "7", x)
#     x <- gsub("آبان", "8", x)
#     x <- gsub("آذر", "9", x)
#     x <- gsub("دی", "10", x)
#     x <- gsub("بهمن", "11", x)
#     x <- gsub("اسفند", "12", x)
#     dd <- strsplit(x, " +")[[1]]
#     jal2greg(
#       as.numeric(dd[3]),
#       as.numeric(dd[2]),
#       as.numeric(dd[1])
#     )
#   }
#   created_at_parsed <- do.call(lapply(created_at_uniq, fun), what = c)
#   created_at_m <- setNames(created_at_parsed, created_at_uniq)
#   new_created_at <- map(comments$created_at, ~ created_at_m[[.x]])
#   new_created_at <- do.call(new_created_at, what = c)
#   comments$created_at_greg <- new_created_at
#   return(comments)
# }
# comments <- comments %>%
#   convert_to_georgian()
```

#### Hmmm ...

```{r}
summary(products)
summary(comments)
```

##### Checking what each column is

```{r}
colnames(products)
colSums(is.na(products)) # seller nan, price 0
products$rate[1:10]
products$rate_cnt[1:100]
products$category_1 %>%
  unique() %>%
  head(50)
products$category_2 %>%
  unique() %>%
  head(20)
products %>%
  filter(category_1 == "بهداشت دهان و دندان") %>%
  arrange(price) # Category 2 is the subcategory
# prices are in RIAL
# Check 3552869 id in products and this link :
# https://www.digikala.com/product/dkp-3552869/%D9%85%D8%B3%D9%88%D8%A7%DA%A9-%D9%87%D8%A7%DB%8C%D8%AF%D9%86%D8%AA-%D9%85%D8%AF%D9%84-909-%D8%A8%D8%A7-%D8%A8%D8%B1%D8%B3-%D9%85%D8%AA%D9%88%D8%B3%D8%B7/
#
products$seller[1:10]
products$sub_category %>% unique() # very few
```

```{r}
colnames(comments)
comments$body[1:10] # comment text
comments$created_at[1:10] # needs parsing
comments %>%
  select(created_at) %>%
  unique() # contains 1399, 1400, 1401, 1402

comments$rate[1:50]
comments$recommendation_status %>% unique()
comments %>%
  count(is_buyer)
comments %>%
  filter(is_buyer == TRUE) %>%
  head(20)
comments$product_id[1:10]
comments$advantages[1:50]
comments$disadvantages[1:50]
comments$likes[1:50]
comments$seller_title[1:50]
comments %>%
  filter(product_id == 13287852)
comments$seller_code[1:10] # what is this?
comments$true_to_size_rate %>% unique() # is fit or not
```

## General Insights About Data

## Ideas
### Predictions
#### Product Recommendation System

```{r}
# colnames(comments) # don't have "user id" thing. cannot know what each user likes.
# colnames(products)
```

<pre>
+ Needs New Data : 8
+ Trivial        : 0
+ Vague Goal     : 5
+ Boring Idea    : 0
+ Sum            : 13
</pre>

#### Sentiment Analysis of Comments
It helps you set competitor benchmarks, track your performance based on customer satisfaction, get product insights, and manage your brand reputation. The trick is to know how to leverage these customer comments and social media chatter and convert them into relevant, actionable insights. In this article, we tell you how.

Goad: Summary of the weak points for each product. 

```{r}
comments$body[1:10]
# Checking number of comments per each product. If it is not much, we possibly cannot rely on the results.
colnames(comments)
comments %>%
  count(product_id) %>%
  arrange(desc(n)) %>%
  head(10) # Maximumn number of comments per product => 400

comments %>%
  count(product_id) %>%
  arrange(desc(n)) %>%
  ggplot(aes(y = n)) +
  geom_boxplot() +
  coord_cartesian(ylim = c(0, 50))
```

<pre>
+ Needs New Data : 8
+ Trivial        : 0
+ Vague Goal     : 5
+ Boring Idea    : 0
+ Sum            : 13
</pre>

#### Stock Out
```{r}
colnames(products)
colnames(comments)
comments %>% nrow()
comments$id %>%
  unique() %>%
  length()
comments %>%
  filter(grepl("موجود", body)) %>%
  group_by(product_id) %>%
  summarise(cnt = n()) %>%
  ungroup() %>%
  arrange(cnt)
```
Suggesting an optimal price/description for a product to acheive maximum profit.

#### Product Being Fake Matters?

#### Analysis On Fake Comments
```{r, eval=FALSE}
p <- comments %>%
  filter(nchar(body) > 20) %>%
  group_by(body) %>%
  summarise(
    cnt = n(),
    pruduct_cnt = length(unique(product_id))
  ) %>%
  ungroup() %>%
  arrange(cnt)

p %>%
  tail(500) %>%
  head(50)

p %>%
  tail(5000) %>%
  head(20)

bb <- "چاپ عالی ،ترجمه خوب،جنس‌ کاغذ خوب،قیمت عالی،بسته بندی عالی، سالم و تمیز، ممنونم"

gg <- "کتاب خوبیه نویسنده قوی ولی کاغذش کمی ضعیفه مطالعه اش رو به همه توصیه میکنم"

hh <- "قیمت کتاب ها در دیجی کالا واقعا عالی هست"
hh_2 <- "چاپ و صحافی خوب"

comments %>%
  filter(body == hh) %>%
  select(id, body, product_id, created_at_greg) %>%
  View()
# 2023-07-18
# 1806641
p_ids <- (comments %>%
  filter(body == bb))$product_id
p_ids %>% length()
comments %>%
  filter(product_id %in% p_ids[6:10]) %>%
  count(created_at_greg, product_id) %>%
  ggplot() +
  geom_point(aes(x = created_at_greg, y = n)) +
  facet_grid(. ~ product_id)
comments %>%
  filter(product_id == 1806641) %>%
  arrange(created_at_greg) %>%
  View()


p_ids <- (comments %>%
  filter(body == gg))$product_id

colnames(products)

products %>%
  filter(id %in% p_ids)
p_ids
```

### Financial
#### Price Elasticity of Demand
#### Analysis Of Stock Out
#### Products With High Return
#### Demand Forcasting
#### Similar Product Analysis


### Marketing 
#### Customer Segmentation
#### Customer Retention Strategy
#### Create Product Bundle
#### Product Description Quality Analysis
#### Customer Churn Prediction
#### Seller Response Rate And Changes To Comments
#### Finding Topics Using Comments
#### Important Factors In a Good Product
#### Effect Of Sanction On Digikala on the Purchases
#### Trends in Seasons

### Fraud Detection
#### Fake Product Detection
#### Spam Comments Detection
#### Review Evaluation System

### Credit Systems
#### Seller Reputation Analysis
#### Seller Performance Evaluation
