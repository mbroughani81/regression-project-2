```{r setup}
knitr::opts_chunk$set(cache = TRUE)
```

```{r}
load_libraries <- function() {
  library(readr)
  library(dplyr)
  library(ggplot2)
  library(jalcal)
  library(furrr)
  library(purrr)
}
load_libraries()
```

```{r}
products <- read_csv("data/digikala-products.csv")
comments <- read_csv("data/digikala-comments.csv")
```

#### Products - rename columns 

```{r}
rename_columns <- function(df) {
  df %>%
    rename(
      rate = Rate,
      rate_cnt = Rate_cnt,
      category_1 = Category1,
      category_2 = Category2,
      brand = Brand,
      price = Price,
      seller = Seller,
      is_fake = Is_Fake
    )
}
products <- rename_columns(products)

comments %>% nrow()

created_at <- comments$created_at %>% unique()
fun <- function(x) {
  x <- gsub("فروردین", "1", x)
  x <- gsub("اردیبهشت", "2", x)
  x <- gsub("خرداد", "3", x)
  x <- gsub("تیر", "4", x)
  x <- gsub("مرداد", "5", x)
  x <- gsub("شهریور", "6", x)
  x <- gsub("مهر", "7", x)
  x <- gsub("آبان", "8", x)
  x <- gsub("آذر", "9", x)
  x <- gsub("دی", "10", x)
  x <- gsub("بهمن", "11", x)
  x <- gsub("اسفند", "12", x)
  dd <- strsplit(x, " +")[[1]]
  jal2greg(
    as.numeric(dd[3]),
    as.numeric(dd[2]),
    as.numeric(dd[1])
  )
}

created_at_m <- do.call(lapply(created_at, fun), what = c)

ll <- list()

length(result_list)
for (i in 1:length(result_list)) {
  ll[created_at[i]] <- result_list[i]
}
ll

x %>% map(function(x) {
  dd <- strsplit(x, " +")[[1]]
  print(dd)
  jal2greg(
    as.numeric(dd[3]),
    as.numeric(dd[2]),
    as.numeric(dd[1])
  )
})
length(created_at)
created_at

convert_to_georgian <- function(comments) {
  print("???")
  created_at_uniq <- comments$created_at %>% unique()
  fun <- function(x) {
    x <- gsub("فروردین", "1", x)
    x <- gsub("اردیبهشت", "2", x)
    x <- gsub("خرداد", "3", x)
    x <- gsub("تیر", "4", x)
    x <- gsub("مرداد", "5", x)
    x <- gsub("شهریور", "6", x)
    x <- gsub("مهر", "7", x)
    x <- gsub("آبان", "8", x)
    x <- gsub("آذر", "9", x)
    x <- gsub("دی", "10", x)
    x <- gsub("بهمن", "11", x)
    x <- gsub("اسفند", "12", x)
    dd <- strsplit(x, " +")[[1]]
    jal2greg(
      as.numeric(dd[3]),
      as.numeric(dd[2]),
      as.numeric(dd[1])
    )
  }
  created_at_parsed <- do.call(lapply(created_at_uniq, fun), what = c)
  created_at_m <- setNames(created_at_parsed, created_at_uniq)
  new_created_at <- map(comments$created_at, ~ created_at_m[[.x]])
  comments$created_at_greg <- new_created_at
  return(comments)
}
comments <- comments %>%
  convert_to_georgian()
```

#### Hmmm ...

```{r}
summary(products)
summary(comments)
```

##### Checking what each column is

```{r}
colnames(products)
colSums(is.na(products)) # seller nan, price 0
products$rate[1:10]
products$rate_cnt[1:100]
products$category_1 %>%
  unique() %>%
  head(50)
products$category_2 %>%
  unique() %>%
  head(20)
products %>%
  filter(category_1 == "بهداشت دهان و دندان") %>%
  arrange(price) # Category 2 is the subcategory
# prices are in RIAL
# Check 3552869 id in products and this link :
# https://www.digikala.com/product/dkp-3552869/%D9%85%D8%B3%D9%88%D8%A7%DA%A9-%D9%87%D8%A7%DB%8C%D8%AF%D9%86%D8%AA-%D9%85%D8%AF%D9%84-909-%D8%A8%D8%A7-%D8%A8%D8%B1%D8%B3-%D9%85%D8%AA%D9%88%D8%B3%D8%B7/
#
products$seller[1:10]
products$sub_category %>% unique() # very few
```

```{r}
colnames(comments)
comments$body[1:10] # comment text
comments$created_at[1:10] # needs parsing
comments %>%
  select(created_at) %>%
  unique() # contains 1399, 1400, 1401, 1402

comments$rate[1:50]
comments$recommendation_status %>% unique()
comments %>%
  count(is_buyer)
comments %>%
  filter(is_buyer == TRUE) %>%
  head(20)
comments$product_id[1:10]
comments$advantages[1:50]
comments$disadvantages[1:50]
comments$likes[1:50]
comments$seller_title[1:50]
comments %>%
  filter(product_id == 13287852)
comments$seller_code[1:10] # what is this?
comments$true_to_size_rate %>% unique() # is fit or not
```

## General Insights About Data

```{r}
# Clean
```

## Ideas
### Predictions
#### Product Recommendation System

```{r}
# colnames(comments) # don't have "user id" thing. cannot know what each user likes.
# colnames(products)
```

<pre>
+ Needs New Data : 8
+ Trivial        : 0
+ Vague Goal     : 5
+ Boring Idea    : 0
+ Sum            : 13
</pre>

#### Sentiment Analysis of Comments
It helps you set competitor benchmarks, track your performance based on customer satisfaction, get product insights, and manage your brand reputation. The trick is to know how to leverage these customer comments and social media chatter and convert them into relevant, actionable insights. In this article, we tell you how.

Goad: Summary of the weak points for each product. 

```{r}
comments$body[1:10]
# Checking number of comments per each product. If it is not much, we possibly cannot rely on the results.
colnames(comments)
comments %>%
  count(product_id) %>%
  arrange(desc(n)) %>%
  head(10) # Maximumn number of comments per product => 400

comments %>%
  count(product_id) %>%
  arrange(desc(n)) %>%
  ggplot(aes(y = n)) +
  geom_boxplot() +
  coord_cartesian(ylim = c(0, 50))
```

<pre>
+ Needs New Data : 8
+ Trivial        : 0
+ Vague Goal     : 5
+ Boring Idea    : 0
+ Sum            : 13
</pre>

#### Product Popularity/Profit Prediction
Based on the all the factors (price, description, trends, and ...), give an estimation of 
the sales! 

#### Price/Description Optimization
```{r}
colnames(products)
colnames(comments)
comments %>% nrow()
comments$id %>%
  unique() %>%
  length()
filter(comments, grepl("موجود", body)) %>%
  tail(20)
```
Suggesting an optimal price/description for a product to acheive maximum profit.

#### Product Being Fake Matters?

### Financial
#### Price Elasticity of Demand
#### Analysis Of Stock Out
#### Products With High Return
#### Demand Forcasting
#### Similar Product Analysis
Analysis on the correlation between products that are substitue or antisubstitue


### Marketing 
#### Customer Segmentation
#### Customer Retention Strategy
#### Create Product Bundle
#### Product Description Quality Analysis
#### Customer Churn Prediction
#### Seller Response Rate And Changes To Comments
#### Finding Topics Using Comments
#### Important Factors In a Good Product
#### Effect Of Sanction On Digikala on the Purchases
#### Trends in Seasons

### Fraud Detection
#### Fake Product Detection
#### Spam Comments Detection
#### Review Evaluation System

### Credit Systems
#### Seller Reputation Analysis
#### Seller Performance Evaluation
